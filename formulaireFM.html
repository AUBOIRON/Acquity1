<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Acquity - Formulaire FM</title>
    <meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="keywords" content="acquity software,acquitysoftware,acquityCX,acquity CX,acquityRP,acquity RP,acquityRH,acquity RH,acquityAM,acquity AM,acquityFM,acquity FM,logiciel achat,logiciel stock,logiciel parc,gestion de parc,asset management,gmao,help desk,inventaire,gestion des incidents,facility management,gestion contact,gestion des elus,gestion des reunions,gestion des evenements,seminaire,organisation,club,presse,fournisseur,contrat,code barres,RFID" />
	<meta name="description" content="ACQUITY software propose une gamme dédiée aux entreprises publiques et privées. Elle répond aux attentes des Services Généraux, Financiers, Achats, Logistique, Informatique, Marketing, Communication, Commercial et Ressources humaines." />
    <link rel="shortcut icon" href="${APP:CONTEXT}/bootstrap_ext/images/acquity_icon.ico" />
    <link rel="icon" type="image/png" href="${APP:CONTEXT}/bootstrap_ext/images/acquity_icon.png" />
    <!-- On ouvre la fenêtre à la largeur de l'écran -->
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Intégration du CSS Bootstrap -->
	<link href="${APP:CONTEXT}/bootstrap/css/bootstrap.min.css" rel="stylesheet">
	
	<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
	<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
	
	<!--[if lt IE 9]>
		<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
		<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
	<![endif]-->
	
	<link href="${APP:CONTEXT}/bootstrap_ext/css/styles.css" rel="stylesheet">
	<link href="${APP:CONTEXT}/bootstrap_ext/css/bootstrap-datetimepicker.min.css" rel="stylesheet">
	<link href="${APP:CONTEXT}/bootstrap_ext/css/bootstrap-select.min.css" rel="stylesheet">
	<!-- For table sorter jQuery plugin -->
	<link href="${APP:CONTEXT}/bootstrap_ext/css/theme.blue.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

 <style>
    .fmFormVerdana16 {
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        font-size: 16pt;
        font-weight: bold;
        color: #1F497D;
    }
    .fmFormVerdana12 {
        font-family: Verdana, Geneva, Tahoma, sans-serif;
        font-size: 12pt;
        font-weight: bold;
        color: #1F497D;
    }
    </style>

</head>
<body style="overflow-x: hidden">
    <section id="formHeader" style="background-color:#1F497D;margin:0;padding:0">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3 d-flex flex-wrap align-items-center col-sm-3 col-12" style="text-align: center;">
                    <p style="color:white; font-size: 16pt; margin:0 auto">
                        <a href="${APP:CONTEXT}">
                            ${IF:'${P:demande.demandeur.cxsService.cxsSociete.image}'!='':
                                <img src="${APP:CONTEXT}/.cxuDownload?contextDir=${APP:CONTEXTDIR}&object=cxsSociete&fileName=fromDisk.${P:demande.demandeur.cxsService.cxsSociete.image}" style="height:50px;width:auto;">
                            @@@ ${IF:'${P:demande.demandeurCompte.image}'!='':
                                <img src="${APP:CONTEXT}/.cxuDownload?contextDir=${APP:CONTEXTDIR}&object=compte&fileName=fromDisk.${P:demande.demandeurCompte.image}" style="height:50px;width:auto;">
                            @@@
                                <img style="height:50px;width:auto;" alt="ACQUITY software" src="${APP:CONTEXT}/images/logo_login.png" />
                            }}
                        </a>
                    </p>
                </div>
                <div class="col-md-3 d-flex flex-wrap align-items-center col-sm-3 col-6">
                    <p style="color:white;margin:0 auto">
                        <b>${I18N:${language}:demande.demandeur}</b><br> ${P:demande.demandeur.completeName}${P:demande.demandeurContact.completeName}<br> ${P:demande.serviceDemandeur.nom}${P:demande.demandeurCompte.nom}
                    </p>
                </div>
                <div class="col-md-3 d-flex flex-wrap align-items-center col-sm-3 col-6">
                    <p style="color:white;margin:0 auto">
                        ${I18N:${language}:demande.lieu}<br>${P:demande.lieu.numero} ${P:demande.etage} ${P:demande.cxsBatiment.nom} ${P:demande.cxsBatiment.cxsAdresse.adresseComplete}
                    </p>
                </div>
                <div class="col-md-3 d-flex flex-wrap align-items-center col-sm-3 col-12" style="border-left: 1px solid white;text-align: center;">
                    <p style="color:white;margin:0 auto">
                        ${P:affectation}
                    </p>
                </div>
            </div>
         </div>
     </section>
    <section id="formInfos">
        <div class="container-fluid" style="background-image:url(${APP:CONTEXT}/images/FM-cover.png); background-size:cover;background-repeat:no-repeat; background-position: center; ">
            <div class="row" style="color:white;">
                <div class="col-md-9 col-sm-6 col-6" style="text-align: center; padding:15px;">
                    <p style="margin:0">
                        ${P:demande.numero}
                    </p>
                    <p>
                        ${P:demande.detailStatut}
                    </p>
                </div>
                <div class="col-md-3 col-sm-6 col-6" style="text-align: center; padding:15px;">
                    <p style="margin:0 auto">
                        ${I18N:${language}:all.createdDate}<br>
                        ${FORMAT:${P:demande.createdDate?string(EEEEE)}?capitalize} ${P:demande.createdDate?string(d MMMM yyyy HH:mm)}
                    </p>
                </div>
            </div> 
            <div class="container" style="margin:0 auto;background-color:white;opacity:0.9;">
                <div class="row" style="margin-right:10px;margin-left:10px">
                    <div class="col-12" style="border-bottom:0.5px solid #BEB9B8;">
                        <p class="fmFormVerdana16" style="padding-top: 15px;margin:0 auto">Informations générales</p>
                    </div>
                </div>
                <div class="row m-0">
                    <div class="col-md-3 col-12">
                        <p class="fmFormVerdana12" style="padding-top: 15px;margin:0 auto">${I18N:${language}:demandeClassification}</p>
                    </div>
                    <div class="col-md-4 col-4" style="text-align: left">
                        <p style="font-size:12pt;padding-top: 15px; margin:0 auto;"> ${P:demande.demandeClassification.nom}</p>
                    </div>
                    <div class="col-md-5 col-sm-12 col-12">
                      
                    </div>
                </div>
                <div class="row m-0">
                    <div class="col-md-2 col-12">
                        <p class="fmFormVerdana12" style="padding-top: 15px;margin:0 auto">${I18N:${language}:demandeSymptome}</p>
                    </div>
                    <div class="col-md-10 col-12" style="text-align: left">
                    <p style="font-size:12pt;padding-top: 15px; margin:0 auto;">${P:demande.demandeSymptome.nom}</p>
                    </div>
                </div>
                <div class="row m-0">
                        <div class="col-md-2 col-12">
                            <p class="fmFormVerdana12" style="padding-top: 15px;margin:0 auto">${I18N:${language}:demande.remarque}</p>
                        </div>
                        <div class="col-md-10 col-12" style="text-align: left">
                            <p style="font-size:12pt;padding-top: 15px; margin:0 auto;"></p>
                        </div>
                </div>
                <!--Formulaire + Fichier-->
                <div class="row m-0">
                    <div class="col-lg-6 col-md-12">
                        <div class="col-md-12"  style="border-bottom:0.5px solid #BEB9B8;">
                                <p class="fmFormVerdana16" style="padding-top: 15px;margin:0 auto">Formulaire d'action</p> 
                        </div>
                        <div class="col-md-12">
                            <div class="row">
                                <div class="col-md-12" style="margin-top: 10px;">
                                        <label for="dateDebut">${I18N:${language}:all.dateDebut}</label>
                                        <input type="date" class="form-control" id="DateDebut" name="dateDebut" placeholder="Date début" checked required>
                                </div> 
                                <div class="col-md-12" style="margin-top: 10px;">   
                                        <label for="dateDebut">${I18N:${language}:all.dateFin}</label>
                                        <input type="date" class="form-control" id="DateFin" name="dateFin" placeholder="Date fin" checked required>
                                </div> 
                            </div>
                            <div class="row">
                                <div class="col-md-12" style="margin-top: 15px;">
                                    <input type="text" class="form-control" id="Libelle" name="Libelle" placeholder="Libellé">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12" style="margin-top: 15px;">
                                    <textarea class="form-control" id="exampleFormControlTextarea1"  rows="5" name="Commentaire" placeholder="Commentaires"></textarea>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12" style="margin-top: 15px; text-align: center">
                                    <button type="button" class="btn btn-primary" style="height:50px; width: 100px; font-size: 14pt; font-family: Verdana;" id="registerButton" name="registerButton"	onclick="submitRegistration();return false;">${I18N:${language}:all.valider}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 col-md-12">
                        <div class="row m-0">
                            <div class=" col-lg-6 col-md-6 col-sm-6 col-6 p-0"  style="border-bottom:0.5px solid #BEB9B8">
                                  ${FOREACH:demande.objects:objItem:
                                       (objItem.cxsLocal.completeName)
                                   }
                               
                                 ${VS:docs:list(cxsDocumentObject:(,parentId=${P:id},and,parentType=demandeAction,),or,(,parentId=${P:demande.id},and,parentType=demande,))}
                                <p class="fmFormVerdana16" style="padding-top: 15px;margin:0 auto">${I18N:${language}:button.docJoints}</p> 
                            </div>
                            <div class="col-lg-6 col-md-6 col-sm-6 col-6 p-0"  style="border-bottom:0.5px solid #BEB9B8;">
                                <p style="padding-top: 20px; margin:0 auto">(Docx, Text, PDF, PNG, JPG)</p>
                            </div>
                            <div class="col-md-12 col-12" style="margin-top: 35px;">
                                <a href="javascript:addNewFile();"><button type="button" class="btn btn-outline-secondary"><img src="${APP:CONTEXT}/acquityCX/images/toolbar/new.png" id="imgAddNewFile" style="width:24px;height:auto;">
                                    Télécharger un fichier </button></a>
                                <form class="form-horizontal hidden" role="form" style="padding-left:15px;padding-right:15px;"
                                id="fileForm" name="fileForm" method="post" enctype="multipart/form-data">		
                                <div class="form-group form-group-sm" style="margin-bottom:5px;">
                                    <div class="input-group col-sm-9">
                                       <input type="file" id="fileInput" name="fileInput" class="filestyle" data-buttonText="..." data-size="sm">
                                    </div>
                                    <span class="help-block"></span>
                                </div>		
                                <div class="row">
                                    <div class="col-sm-3"></div>
                                    <div class="col-sm-9 progress hidden" id="uploadFileProgress" name="uploadFileProgress">
                                        <div class="progress-bar progress-bar-striped" role="progressbar" 
                                                aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                                                Uploading file, please wait...
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-3"></div>
                                    <div class="col-sm-9 alert-warning hidden" id="uploadFileError" name="uploadFileError"></div>
                                </div>
                                <input type="hidden" id="tempFileName" name="tempFileName"/>
                                <input type="hidden" id="realFileName" name="realFileName"/>
                            </form>
                            </div>
                            ${IF:${V:docs?size}==0::
                            <div class="col-md-12 col-12" style="border: 0.5px solid #BEB9B8;margin-top:12px">
                                <div class="row" style="margin:0 auto;">
                                    <div class="col-lg-8 col-md-8 col-sm-8 col-8">
                                        <p style="margin:0 auto; text-align: center">
                                           NOM DE FICHIER
                                        </p>
                                    </div>
                                    <div class="col-lg-4 col-md-4 col-sm-4 col-4">
                                        <p style="margin:0 auto; text-align: center">
                                            RETIRER
                                        </p>
                                    </div>
                                </div>
                                ${FOREACH:v.docs:docItem:
                                <div class="row" style="margin:0 auto;">
                                    <div class="col-lg-8 col-md-8 col-sm-8 col-8">
                                        <p style="font-size:12pt;padding-top: 15px; margin:0 auto; text-align: center">
                                            <i class="fa fa-file" aria-hidden="true"></i>
                                            <a href="${APP:CONTEXT}/.cxuDownload?contextDir=${APP:CONTEXTDIR}&object=(docItem.cxsDocument.group)&fileName=fromDisk.(docItem.cxsDocument.fileName)" 
			  			                    target="_blank"> (docItem.cxsDocument.title)</a>
                                        </p>
                                    </div>
                                    <div class="col-lg-4 col-md-4 col-sm-4 col-4">
                                        (docItem.[equal(createdBy;${APP:USER})@@@
                                        <p style="margin:0 auto; text-align: center; padding-top: 15px;">
                                            <a href="javascript:deleteDocJoined((id));">
                                            <i class="fa fa-trash" aria-hidden="true"></i>
                                            </a>
                                        </p>])
                                        (docItem.[notEqual(createdBy;${APP:USER})@@@
                                        <p style="margin:0 auto; text-align: center; padding-top: 15px;">
                                            <i class="fa fa-trash" aria-hidden="true"></i>
                                        </p>])
                                    </div>
                                </div>
                                }
                            </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-12" style="margin: 15px">
                        <p class="text-center fmFormVerdana16">Merci pour votre collaboration</p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div style="height:50px"></div>
            </div>
        </div>
    </section>
<!-- Intégration de la libraire jQuery -->
<script src="${APP:CONTEXT}/bootstrap_ext/js/jquery-2.1.0.min.js"></script>
<script src="${APP:CONTEXT}/bootstrap_ext/js/jquery.validate.min.js"></script>
<!-- Intégration de la libraire de composants du Bootstrap -->
<script src="${APP:CONTEXT}/bootstrap/js/bootstrap.min.js"></script>
<script src="${APP:CONTEXT}/bootstrap_ext/js/bootstrap-datetimepicker.min.js"></script>
<script src="${APP:CONTEXT}/bootstrap_ext/js/bootstrap-datetimepicker.fr.js"></script>
<script src="${APP:CONTEXT}/bootstrap_ext/js/bootstrap-select.min.js"></script>
<script src="${APP:CONTEXT}/bootstrap_ext/js/bootstrap-filestyle.min.js"></script>
<script src="${APP:CONTEXT}/bootstrap_ext/js/acquity-forms.js"></script>

<script type="text/javascript">

$(document).ready(function () {
	$('.selectpicker').selectpicker();

${IF:${VE:responseIntervenant}==1::
    $("#dateDebut").datetimepicker({startView:2,autoclose:true, format: "dd/mm/yyyy hh:ii",language:"fr"});
    $("#dateFin").datetimepicker({startView:2,autoclose:true, format: "dd/mm/yyyy  hh:ii",language:"fr"});
    
	$('#dateDebut').datetimepicker().on('changeDate', function(ev){
		$('#dateFin').datetimepicker('setStartDate', ev.date);
	});
	$('#dateFin').datetimepicker().on('changeDate', function(ev){
		$('#dateDebut').datetimepicker('setEndDate', ev.date);
	});

	//$('input[name="dateDebut"]').rules("add", { required:true });
	//$('input[name="dateFin"]').rules("add", { required:true });

${IF:'${EVAL:replace('${dateDebut}',':',' ')}'=='':@@@
	//$('#dateDebut').val('${dateDebut}');
	$('#dateFin').datetimepicker('setStartDate', '${dateDebut}');
}
${IF:'${EVAL:replace('${dateFin}',':',' ')}'=='':@@@
	//$('#dateFin').val('${dateFin}');
	//$('#dateDebut').datetimepicker('setEndDate', '${dateFin}');
}

    $('#registerForm').validate();

	$("#fileForm").validate();
	$("#fileInput").filestyle({buttonText:" ", size: "sm"});
	$("#fileInput").change(function() {cxOnFileChange('${APP:CONTEXT}', '', 'addDocToObject');});
    $("#fileForm").removeClass("show").addClass("hidden");
}
});


function addNewFile() {
	if ($("#fileForm").is(":visible")) {
		$("#fileForm").removeClass("show").addClass("hidden");
		$("#imgAddNewFile").attr("src","${APP:CONTEXT}/acquityCX/images/toolbar/new.png");
	} else {
    	$("#fileForm").removeClass("hidden").addClass("show");
		$("#imgAddNewFile").attr("src","${APP:CONTEXT}/acquityCX/images/toolbar/cancel.png");
    }
}

function addDocToObject() {
	var fileNames = {//
		realFileName :  $("#realFileName").val(), //
		tempFileName:  $("#tempFileName").val()//
	};
	var wsURL = "${APP:CONTEXT}/rest/demande/addDocJoined?${portail.params}";
	$.ajax({
            url: wsURL,
            type: "POST",
           // cache: false,
            dataType: "json", // selon le retour attendu
            data: fileNames
	}).fail(function(jqXHR, textStatus, errorThrown) {
			//if fails
			//alert('addDocToObject fails');
			$("#uploadFileProgress").removeClass("active").removeClass("show").addClass("hidden");
			$("#uploadFileError").removeClass("hidden").addClass("show").text("File too big");
			$("#realFileName").val("");
			$("#tempFileName").val("");

			alert("textStatus=" + textStatus
				+ ", errorThrown=" + errorThrown
				+ ", jqXHR.responseText=" + jqXHR.responseText
				+ ", jqXHR.responseXML=" + jqXHR.responseXML);
			//for (variable in jqXHR)
   			//	alert(variable +"="+eval("jqXHR."+variable));
   			
            $('#fileForm').valid();
	}).done(function(data, textStatus, jqXHR) {
			//alert('addDocToObject ok');
			$("#uploadFileProgress").removeClass("active").removeClass("show").addClass("hidden");
			if(data.error){
				$("#uploadFileError").removeClass("hidden").addClass("show");
				$("#uploadFileError").text("L'erreur suivante s'est produite : " + data.error);
			} else {
				//refresh
				window.location.reload();
			}
	});
}

function deleteDocJoined(docId) {
	var wsURL = "${APP:CONTEXT}/rest/demande/deleteDocJoined?${portail.params}&djid="+docId;
	$.ajax({
            url: wsURL,
            type: "get",
            dataType: "json" // selon le retour attendu
	}).fail(function(jqXHR, textStatus, errorThrown) {
			//if fails
			if(jqXHR.responseText){
				alert(jqXHR.responseText);
			} else {
				alert("deleteDocJoined : textStatus=" + textStatus
					+ ", errorThrown=" + errorThrown
					+ ", jqXHR.responseText=" + jqXHR.responseText
					+ ", jqXHR.responseXML=" + jqXHR.responseXML);
			}

	}).done(function(data, textStatus, jqXHR) {
		//refresh
		location.reload(); 
	});
}


//callback handler for form submit
function submitRegistration() {
	$("#registerResult").removeClass("hidden").addClass("show").removeClass("alert-warning").removeClass("alert-success").text("");

	var RegisterForm = $('#registerForm');
	if (!RegisterForm.valid())
        return false;	
	if( !$('#dateDebut').val() || !$('#dateFin').val()) {
		if( !$('#dateDebut').val()) {
			$('#dateDebut').closest('.form-group').removeClass('has-success').addClass('has-error');
			$('#dateDebut').closest('.form-group').find('.glyphicon').removeClass('glyphicon-ok').addClass('glyphicon-warning-sign');
		}
		if( !$('#dateFin').val()) {
			$('#dateFin').closest('.form-group').removeClass('has-success').addClass('has-error');
			$('#dateFin').closest('.form-group').find('.glyphicon').removeClass('glyphicon-ok').addClass('glyphicon-warning-sign');
		}
        return false;	
	}

	$("#registerProgress").removeClass("hidden").addClass("show").addClass("active");
	$("#registerButton").prop("disabled",true);

	var formData = RegisterForm.serialize();
	var formURL = RegisterForm.attr("action") + "?${portail.params}";
	if (getParam("s")!=null)
		formURL=formURL+"&s="+getParam("s");
	
	$.ajax({
		type: "POST",
		url : formURL,
		dataType : "json",
        data: formData
	})
	.fail(function(jqXHR, textStatus, errorThrown)
		{
			//alert("fails");
			$("#registerProgress").removeClass("active").removeClass("show").addClass("hidden");
			$("#registerResult").removeClass("alert-success").addClass("alert-warning").text("L'erreur suivante s'est produite : " + jqXHR.responseText);
			$("#registerButton").prop("disabled",false);
		})
	.done(function(data, textStatus, jqXHR)
		{
			$("#registerProgress").removeClass("active").removeClass("show").addClass("hidden");
			if(data.error){
				$("#registerResult").removeClass("alert-warning").addClass("alert-success").text("L'erreur suivante s'est produite : " + data.error);
				
			} else{
				$("#registerResult").removeClass("alert-warning").addClass("alert-success").text("Success");
				document.location.href = "${APP:CONTEXT}/rest/demande/showAction?key="+data.key+"&c=${APP:CONTEXTDIR}";
			}
			$("#registerButton").prop("disabled",false);
		});
}
</script>
</body>
</html>